name: CI/CD Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-test:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: orderuser
          POSTGRES_PASSWORD: orderpass
          POSTGRES_DB: orders
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U orderuser"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    
    steps:
      # 1. Checkout code
      - name: Checkout code
        uses: actions/checkout@v4
      
      # 2. Set up Python
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      # 3. Install dependencies for all services
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov flake8
          
          # Install user-service dependencies
          pip install -r user-service/requirements.txt
          
          # Install product-service dependencies
          pip install -r product-service/requirements.txt
          
          # Install order-service dependencies
          pip install -r order-service/requirements.txt
      
      # 4. Lint with flake8
      - name: Lint with flake8
        run: |
          # Stop build if there are Python syntax errors
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          # Exit-zero treats all errors as warnings
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
      
      # 5. Run tests for user-service
      - name: Test user-service
        run: |
          cd user-service
          pytest tests/ -v --cov=. --cov-report=xml
        if: always()
      
      # 6. Run tests for product-service
      - name: Test product-service
        run: |
          cd product-service
          pytest tests/ -v --cov=. --cov-report=xml
        if: always()
      
      # 7. Run tests for order-service
      - name: Test order-service
        env:
          DATABASE_URL: postgresql://orderuser:orderpass@localhost:5432/orders
        run: |
          cd order-service
          pytest tests/ -v --cov=. --cov-report=xml
        if: always()
      
      # 8. Set up Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      # 9. Build Docker images (but don't push yet)
      - name: Build user-service image
        uses: docker/build-push-action@v5
        with:
          context: ./user-service
          push: false
          tags: user-service:latest
      
      - name: Build product-service image
        uses: docker/build-push-action@v5
        with:
          context: ./product-service
          push: false
          tags: product-service:latest
      
      - name: Build order-service image
        uses: docker/build-push-action@v5
        with:
          context: ./order-service
          push: false
          tags: order-service:latest

  # Optional: Deploy job (uncomment when ready)
  # deploy:
  #   needs: build-test
  #   runs-on: ubuntu-latest
  #   if: github.ref == 'refs/heads/main'
  #   steps:
  #     - name: Deploy notification
  #       run: echo "Ready to deploy!"
